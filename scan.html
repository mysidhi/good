<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Camera ‚Äî Responsive Capture & QR (Toggle) + Shutter</title>

<!-- jsQR library for scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  :root{
    --bg1:#071226;
    --muted: rgba(255,255,255,0.75);
    --primary:#007aff;
    --accent:#E3910B;
    --success:#34c759;
    --danger:#ff3b30;
    --card-radius:14px;
    --gap:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{ height:100%; margin:0; background:linear-gradient(180deg,#071226 0%, #0b2538 100%); color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  .wrap{
    max-width:1100px;
    margin:18px auto;
    padding:16px;
    box-sizing:border-box;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius: var(--card-radius);
    padding:14px;
    display:grid;
    gap:14px;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .title { font-weight:700; font-size:1.05rem; }
  .subtitle { color:var(--muted); font-size:0.88rem; }

  /* layout: video left, controls right on wide screens */
  .layout {
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:16px;
    align-items:start;
  }

  .viewer {
    border-radius:12px;
    overflow:hidden;
    position:relative;
    background:#000;
    min-height: 220px;
  }

  .video-wrap{
    position:relative;
    width:100%;
    aspect-ratio: 16/9;
    background:#000;
  }

  video#cam {
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    transform: scaleX(-1); /* mirror by default for front UX (flipped when using back) */
    transition: transform .2s ease;
  }

  /* shutter flash overlay */
  .flash {
    position:absolute;
    inset:0;
    background: white;
    opacity:0;
    pointer-events:none;
  }
  .flash.flash-animate {
    animation: flashAnim .45s ease-out forwards;
  }
  @keyframes flashAnim {
    0% { opacity: 0.98; }
    60% { opacity: 0.35; }
    100% { opacity: 0; }
  }

  .status {
    position:absolute;
    left:10px;
    top:10px;
    background: rgba(0,0,0,0.35);
    padding:8px 10px;
    border-radius:999px;
    display:inline-flex;
    gap:8px;
    align-items:center;
    font-size:0.86rem;
    color:var(--muted);
    border:1px solid rgba(255,255,255,0.03);
    backdrop-filter:blur(6px);
  }
  .status .dot{ width:10px; height:10px; border-radius:50%; background:#999; }
  .status.live .dot{ background:var(--success); box-shadow:0 0 8px rgba(52,199,89,0.12); }

  /* controls area */
  .controls {
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .panel {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .btn {
    appearance:none;
    border:none;
    padding:12px 14px;
    min-width:110px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    color: #0b1220;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 8px 20px rgba(2,6,23,0.35);
    transition: transform .08s ease;
  }
  .btn:active{ transform:translateY(1px); }

  .btn.primary { background: linear-gradient(90deg,var(--primary), #005fcc); color:#fff; }
  .btn.accent { background: linear-gradient(90deg,var(--accent), #d57808); color:#fff; }
  .btn.success { background: linear-gradient(90deg,var(--success), #2fb04a); color:#052206; }
  .btn.danger { background: linear-gradient(90deg,var(--danger), #d42b22); color:#fff; }
  .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  .preview {
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
    justify-content:center;
  }
  img#photo {
    width:100%;
    max-width:320px;
    border-radius:10px;
    border:2px solid rgba(255,255,255,0.04);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .download-row {
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    width:100%;
    flex-wrap:wrap;
  }

  #qrResult { text-align:center; color:#c6f4d1; font-weight:700; word-break:break-word; }

  .hint { color:var(--muted); text-align:center; font-size:0.9rem; }

  footer.note { text-align:center; color:var(--muted); font-size:0.82rem; padding-top:6px; }

  /* toggle control style */
  .toggle {
    display:inline-flex;
    align-items:center;
    gap:10px;
    padding:6px;
    border-radius:999px;
    background: rgba(255,255,255,0.03);
    border:1px solid rgba(255,255,255,0.04);
  }
  .toggle .label { color:var(--muted); font-weight:600; font-size:0.92rem; }
  .switch {
    width:60px;
    height:34px;
    background: rgba(255,255,255,0.06);
    border-radius:999px;
    display:flex;
    align-items:center;
    padding:4px;
    cursor:pointer;
  }
  .knob {
    width:26px;
    height:26px;
    border-radius:50%;
    background: linear-gradient(180deg,#fff,#e6e6e6);
    box-shadow: 0 6px 18px rgba(2,6,23,0.4);
    transform: translateX(0);
    transition: transform .18s cubic-bezier(.2,.9,.2,1);
  }
  .switch.on { background: linear-gradient(90deg,var(--primary), #005fcc); }
  .switch.on .knob { transform: translateX(26px); }

  /* responsive: stack layout on small screens, enlarge touch targets */
  @media (max-width:900px){
    .layout{ grid-template-columns: 1fr; }
    .controls{ order: 2; }
    .btn{ min-width:48%; padding:14px; }
    .panel{ justify-content:center; }
    img#photo { max-width:260px; }
  }
  @media (max-width:420px){
    .btn{ min-width:100%; }
    .panel{ gap:8px; }
    img#photo { max-width:100%; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <div class="title">Camera ‚Äî Capture & QR (Toggle)</div>
        <div class="subtitle">Tap the toggle to change mode. Click image to capture ‚Äî includes shutter animation & sound.</div>
      </div>
      <div id="modeIndicator" style="font-weight:600;color:var(--muted)">Mode: <span style="color:#fff">Capture</span></div>
    </div>

    <div class="layout">
      <!-- Video / Viewer -->
      <div class="viewer">
        <div class="video-wrap" aria-live="polite">
          <div id="statusBadge" class="status" role="status" aria-atomic="true"><span class="dot"></span><span id="statusText">Camera Off</span></div>
          <video id="cam" autoplay muted playsinline></video>
          <canvas id="canvas" style="display:none"></canvas>

          <!-- Shutter flash overlay -->
          <div id="flash" class="flash" aria-hidden="true"></div>
        </div>

        <p id="qrResult" aria-live="polite"></p>
        <p class="hint">Allow camera permission. In QR mode, URLs open automatically.</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
          <div class="toggle" role="group" aria-label="Mode toggle">
            <div class="label">Capture</div>
            <div id="modeSwitch" class="switch" role="button" tabindex="0" aria-pressed="false" aria-label="Toggle mode">
              <div class="knob"></div>
            </div>
            <div class="label">QR</div>
          </div>

          <div style="display:flex;gap:10px;">
            <button id="switchFrontBtn" class="btn ghost" title="Front camera">Front</button>
            <button id="switchBackBtn" class="btn ghost" title="Back camera">Back</button>
          </div>
        </div>

        <div class="panel" role="toolbar" aria-label="camera controls">
          <button id="snapBtn" class="btn accent">üì∏ Click Image</button>
          <button id="stopBtn" class="btn danger">Off</button>
        </div>

        <div class="preview" id="previewArea" style="display:none">
          <img id="photo" alt="Captured photo preview">
          <div class="download-row" id="downloadSection" style="display:none">
            <button id="downloadBtn" class="btn success" disabled>‚¨áÔ∏è Download</button>
            <button id="saveBtn" class="btn ghost" title="Save to gallery (Android)">Save to gallery</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="note">Tip: On mobile use the browser download or Save to gallery to store photos.</footer>
  </div>
</div>

<script>
  // state
  let mediaStream = null;
  let currentFacingMode = "environment";
  let currentMode = "capture"; // 'capture' or 'qr'
  let capturedImage = null; // dataURL
  let scanInterval = null;

  // elements
  const video = document.getElementById('cam');
  const canvas = document.getElementById('canvas');
  const photo = document.getElementById('photo');
  const qrResult = document.getElementById('qrResult');
  const downloadSection = document.getElementById('downloadSection');
  const previewArea = document.getElementById('previewArea');

  const snapBtn = document.getElementById('snapBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const saveBtn = document.getElementById('saveBtn');
  const stopBtn = document.getElementById('stopBtn');
  const switchFrontBtn = document.getElementById('switchFrontBtn');
  const switchBackBtn = document.getElementById('switchBackBtn');

  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  const modeIndicator = document.getElementById('modeIndicator');
  const modeSwitch = document.getElementById('modeSwitch');
  const flashEl = document.getElementById('flash');

  // UI helpers
  function setStatus(online, text){
    statusText.textContent = text;
    if(online) statusBadge.classList.add('live'); else statusBadge.classList.remove('live');
  }

  function updateModeUI(){
    modeIndicator.innerHTML = 'Mode: <span style="color:#fff">' + (currentMode === 'capture' ? 'Capture' : 'QR Scan') + '</span>';
    // update toggle visual
    if(currentMode === 'qr'){ modeSwitch.classList.add('on'); modeSwitch.setAttribute('aria-pressed','true'); }
    else { modeSwitch.classList.remove('on'); modeSwitch.setAttribute('aria-pressed','false'); }
  }

  // toggle handler (click & keyboard)
  function toggleMode(){
    currentMode = (currentMode === 'capture') ? 'qr' : 'capture';
    updateModeUI();
    if(currentMode === 'qr'){
      qrResult.textContent = 'Scanning for QR code...';
      previewArea.style.display = 'none';
      downloadSection.style.display = 'none';
      getMediaStream().then(() => startQRScan());
    } else {
      qrResult.textContent = '';
      clearInterval(scanInterval);
      getMediaStream();
    }
  }

  modeSwitch.addEventListener('click', toggleMode);
  modeSwitch.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMode(); }});

  // request camera
  async function getMediaStream(){
    if(mediaStream){
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
      video.srcObject = null;
    }

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: currentFacingMode } },
        audio: false
      });
    } catch (err) {
      // fallback to non-exact constraint
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode },
          audio: false
        });
      } catch (err2){
        console.error('Camera error', err2);
        setStatus(false, 'Camera unavailable or denied');
        alert('Camera not available or permission denied.');
        return;
      }
    }

    video.srcObject = mediaStream;
    if(currentFacingMode === 'user') video.style.transform = 'scaleX(-1)'; else video.style.transform = 'none';
    setStatus(true, 'Camera active');

    return new Promise((resolve) => {
      if (video.readyState >= 2) resolve();
      else video.addEventListener('loadedmetadata', function loaded(){ video.removeEventListener('loadedmetadata', loaded); resolve(); });
    });
  }

  // shutter sound using WebAudio (small synthesized shutter)
  function playShutterSound(){
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'triangle';
      o.frequency.value = 1000;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(ctx.destination);
      const now = ctx.currentTime;
      // quick click: ramp up then down
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.06, now + 0.005);
      o.frequency.setValueAtTime(1000, now);
      o.frequency.exponentialRampToValueAtTime(600, now + 0.08);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.12);
      o.start(now);
      o.stop(now + 0.13);
      // close context after short delay to free resources
      setTimeout(()=> { try { ctx.close(); } catch(e){} }, 400);
    } catch(e){
      // ignore audio errors (user agents may block)
      console.warn('Audio not available', e);
    }
  }

  // animate flash
  function animateFlash(){
    flashEl.classList.remove('flash-animate');
    // force reflow
    void flashEl.offsetWidth;
    flashEl.classList.add('flash-animate');
  }

  // capture
  snapBtn.addEventListener('click', () => {
    if(currentMode !== 'capture') return;
    if(!video.videoWidth) { alert('Video not ready'); return; }
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    if(currentFacingMode === 'user') {
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }

    // shutter effects
    animateFlash();
    playShutterSound();

    capturedImage = canvas.toDataURL('image/png', 0.95);
    photo.src = capturedImage;
    previewArea.style.display = 'flex';
    downloadSection.style.display = 'flex';
    downloadBtn.disabled = false;
  });

  // download
  downloadBtn.addEventListener('click', () => {
    if(!capturedImage) return;
    const a = document.createElement('a');
    a.href = capturedImage;
    a.download = 'mysidhi.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // save to gallery (Android: open blob URL to long-press or trigger download)
  saveBtn.addEventListener('click', async () => {
    if(!capturedImage) return;
    try {
      const blob = await (await fetch(capturedImage)).blob();
      const blobUrl = URL.createObjectURL(blob);
      const w = window.open(blobUrl, '_blank');
      if(!w) downloadBtn.click();
      setTimeout(()=> URL.revokeObjectURL(blobUrl), 30000);
    } catch (err) {
      console.error(err);
      downloadBtn.click();
    }
  });

  // stop camera
  stopBtn.addEventListener('click', () => {
    if(mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
      video.srcObject = null;
      clearInterval(scanInterval);
      setStatus(false, 'Camera Off');
      setTimeout(()=> alert('Camera turned off.'), 10);
    } else setStatus(false, 'Camera Off');
  });

  // switch cameras
  switchFrontBtn.addEventListener('click', () => { currentFacingMode = 'user'; getMediaStream(); });
  switchBackBtn.addEventListener('click', () => { currentFacingMode = 'environment'; getMediaStream(); });

  // QR scan implementation (same as before)
  function startQRScan(){
    clearInterval(scanInterval);
    if(!video.videoWidth) {
      scanInterval = setTimeout(startQRScan, 300);
      return;
    }
    const ctx = canvas.getContext('2d');
    scanInterval = setInterval(() => {
      if(!video.videoWidth) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      if (currentFacingMode === 'user') {
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      } else ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const qr = jsQR(imageData.data, imageData.width, imageData.height);
        if(qr) {
          qrResult.textContent = 'QR Code: ' + qr.data;
          clearInterval(scanInterval);
          if(qr.data && (qr.data.startsWith('http://') || qr.data.startsWith('https://'))) {
            setTimeout(()=> window.open(qr.data, '_blank'), 150);
          }
        }
      } catch (err) {
        console.error('QR error', err);
      }
    }, 450);
  }

  // init
  (async function init(){
    updateModeUI();
    setModeInitial();
    await getMediaStream().catch(()=>{});
  })();

  function setModeInitial(){
    // default capture
    currentMode = 'capture';
    updateModeUI();
  }

  // cleanup
  window.addEventListener('beforeunload', ()=> { if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); });
  // keyboard: space = snapshot, t = toggle
  window.addEventListener('keydown', (e) => {
    if(e.key === ' ') { e.preventDefault(); snapBtn.click(); }
    if(e.key.toLowerCase() === 't') toggleMode();
  });
</script>
</body>
</html>
