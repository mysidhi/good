<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Camera ‚Äî Responsive Capture, Share & Download</title>

<!-- jsQR library for scanning -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<style>
  :root{
    --bg1:#071226;
    --muted: rgba(255,255,255,0.75);
    --primary:#007aff;
    --accent:#E3910B;
    --success:#34c759;
    --danger:#ff3b30;
    --card-radius:14px;
    --gap:12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{ height:100%; margin:0; background:linear-gradient(180deg,#071226 0%, #0b2538 100%); color:#e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  .wrap{
    max-width:1100px;
    margin:18px auto;
    padding:16px;
    box-sizing:border-box;
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius: var(--card-radius);
    padding:14px;
    display:grid;
    gap:14px;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  .title { font-weight:700; font-size:1.05rem; }
  .subtitle { color:var(--muted); font-size:0.88rem; }

  /* layout: video left, controls right on wide screens */
  .layout {
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:16px;
    align-items:start;
  }

  .viewer {
    border-radius:12px;
    overflow:hidden;
    position:relative;
    background:#000;
    min-height: 220px;
  }

  .video-wrap{
    position:relative;
    width:100%;
    aspect-ratio: 16/9;
    background:#000;
  }

  video#cam {
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    transform: scaleX(-1); /* mirror by default for front UX (flipped when using back) */
    transition: transform .2s ease;
  }

  .status {
    position:absolute;
    left:10px;
    top:10px;
    background: rgba(0,0,0,0.35);
    padding:8px 10px;
    border-radius:999px;
    display:inline-flex;
    gap:8px;
    align-items:center;
    font-size:0.86rem;
    color:var(--muted);
    border:1px solid rgba(255,255,255,0.03);
    backdrop-filter:blur(6px);
  }
  .status .dot{ width:10px; height:10px; border-radius:50%; background:#999; }
  .status.live .dot{ background:var(--success); box-shadow:0 0 8px rgba(52,199,89,0.12); }

  /* controls area */
  .controls {
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .panel {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  .btn {
    appearance:none;
    border:none;
    padding:12px 14px;
    min-width:110px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    color: #0b1220;
    background: rgba(255,255,255,0.95);
    box-shadow: 0 8px 20px rgba(2,6,23,0.35);
    transition: transform .08s ease;
  }
  .btn:active{ transform:translateY(1px); }

  .btn.primary { background: linear-gradient(90deg,var(--primary), #005fcc); color:#fff; }
  .btn.accent { background: linear-gradient(90deg,var(--accent), #d57808); color:#fff; }
  .btn.success { background: linear-gradient(90deg,var(--success), #2fb04a); color:#052206; }
  .btn.danger { background: linear-gradient(90deg,var(--danger), #d42b22); color:#fff; }
  .btn.ghost { background: transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  .preview {
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
    justify-content:center;
  }
  img#photo {
    width:100%;
    max-width:320px;
    border-radius:10px;
    border:2px solid rgba(255,255,255,0.04);
    box-shadow: 0 10px 30px rgba(2,6,23,0.6);
  }

  .download-row {
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:center;
    width:100%;
    flex-wrap:wrap;
  }

  #qrResult { text-align:center; color:#c6f4d1; font-weight:700; word-break:break-word; }

  .hint { color:var(--muted); text-align:center; font-size:0.9rem; }

  footer.note { text-align:center; color:var(--muted); font-size:0.82rem; padding-top:6px; }

  /* responsive: stack layout on small screens, enlarge touch targets */
  @media (max-width:900px){
    .layout{ grid-template-columns: 1fr; }
    .controls{ order: 2; }
    .btn{ min-width:48%; padding:14px; }
    .panel{ justify-content:center; }
    img#photo { max-width:260px; }
  }
  @media (max-width:420px){
    .btn{ min-width:100%; }
    .panel{ gap:8px; }
    img#photo { max-width:100%; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <div>
        <div class="title">Responsive Camera ‚Äî Capture & QR</div>
        <div class="subtitle">Works on mobile & desktop. Share or download captured photos.</div>
      </div>
      <div id="modeIndicator" style="font-weight:600;color:var(--muted)">Mode: <span style="color:#fff">Capture</span></div>
    </div>

    <div class="layout">
      <!-- Video / Viewer -->
      <div class="viewer">
        <div class="video-wrap" aria-live="polite">
          <div id="statusBadge" class="status" role="status" aria-atomic="true"><span class="dot"></span><span id="statusText">Camera Off</span></div>
          <video id="cam" autoplay muted playsinline></video>
          <canvas id="canvas" style="display:none"></canvas>
        </div>

        <p id="qrResult" aria-live="polite"></p>
        <p class="hint">Allow camera permission. In QR mode, URLs open automatically.</p>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="panel" role="toolbar" aria-label="camera controls">
          <button id="captureModeBtn" class="btn ghost" aria-pressed="true">Capture Mode</button>
          <button id="snapBtn" class="btn accent">üì∏ Click Image</button>
          <button id="qrModeBtn" class="btn ghost">QR Scan Mode</button>

          <button id="switchFrontBtn" class="btn">Front</button>
          <button id="switchBackBtn" class="btn">Back</button>

          <button id="stopBtn" class="btn danger">Off</button>
        </div>

        <div class="preview" id="previewArea" style="display:none">
          <img id="photo" alt="Captured photo preview">
          <div class="download-row" id="downloadSection" style="display:none">
            <button id="downloadBtn" class="btn success" disabled>‚¨áÔ∏è Download</button>
            <button id="shareBtn" class="btn primary" disabled>üîó Share</button>
            <button id="saveBtn" class="btn ghost" title="Save to gallery (Android)">Save to gallery</button>
          </div>
        </div>
      </div>
    </div>

    <footer class="note">Tip: On mobile use the Share button to send the photo directly (if your browser supports Web Share).</footer>
  </div>
</div>

<script>
  // state
  let mediaStream = null;
  let currentFacingMode = "environment";
  let currentMode = "capture";
  let capturedImage = null; // dataURL
  let scanInterval = null;

  // elements
  const video = document.getElementById('cam');
  const canvas = document.getElementById('canvas');
  const photo = document.getElementById('photo');
  const qrResult = document.getElementById('qrResult');
  const downloadSection = document.getElementById('downloadSection');
  const previewArea = document.getElementById('previewArea');

  const snapBtn = document.getElementById('snapBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const shareBtn = document.getElementById('shareBtn');
  const saveBtn = document.getElementById('saveBtn');
  const stopBtn = document.getElementById('stopBtn');
  const qrModeBtn = document.getElementById('qrModeBtn');
  const captureModeBtn = document.getElementById('captureModeBtn');
  const switchFrontBtn = document.getElementById('switchFrontBtn');
  const switchBackBtn = document.getElementById('switchBackBtn');
  const statusBadge = document.getElementById('statusBadge');
  const statusText = document.getElementById('statusText');
  const modeIndicator = document.getElementById('modeIndicator');

  // UI helpers
  function setStatus(online, text){
    statusText.textContent = text;
    if(online) statusBadge.classList.add('live'); else statusBadge.classList.remove('live');
  }

  function setMode(mode){
    currentMode = mode;
    modeIndicator.innerHTML = 'Mode: <span style="color:#fff">' + (mode === 'capture' ? 'Capture' : 'QR Scan') + '</span>';
    captureModeBtn.setAttribute('aria-pressed', mode === 'capture');
    qrModeBtn.setAttribute('aria-pressed', mode === 'qr');
    if(mode === 'qr'){
      qrResult.textContent = 'Scanning for QR code...';
      previewArea.style.display = 'none';
      downloadSection.style.display = 'none';
      getMediaStream().then(() => startQRScan());
    } else {
      qrResult.textContent = '';
      clearInterval(scanInterval);
      getMediaStream();
    }
  }

  // request camera
  async function getMediaStream(){
    if(mediaStream){
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
      video.srcObject = null;
    }

    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { exact: currentFacingMode } },
        audio: false
      });
    } catch (err) {
      // fallback to non-exact constraint
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode },
          audio: false
        });
      } catch (err2){
        console.error('Camera error', err2);
        setStatus(false, 'Camera unavailable or denied');
        alert('Camera not available or permission denied.');
        return;
      }
    }

    video.srcObject = mediaStream;
    if(currentFacingMode === 'user') video.style.transform = 'scaleX(-1)'; else video.style.transform = 'none';
    setStatus(true, 'Camera active');

    return new Promise((resolve) => {
      if (video.readyState >= 2) resolve();
      else video.addEventListener('loadedmetadata', function loaded(){ video.removeEventListener('loadedmetadata', loaded); resolve(); });
    });
  }

  // capture
  snapBtn.addEventListener('click', () => {
    if(currentMode !== 'capture') return;
    if(!video.videoWidth) { alert('Video not ready'); return; }
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    if(currentFacingMode === 'user') {
      ctx.save();
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.restore();
    } else {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    }

    capturedImage = canvas.toDataURL('image/png', 0.95);
    photo.src = capturedImage;
    previewArea.style.display = 'flex';
    downloadSection.style.display = 'flex';
    downloadBtn.disabled = false;
    shareBtn.disabled = false;
  });

  // download
  downloadBtn.addEventListener('click', () => {
    if(!capturedImage) return;
    const a = document.createElement('a');
    a.href = capturedImage;
    a.download = 'mysidhi.png';
    document.body.appendChild(a);
    a.click();
    a.remove();
  });

  // share using Web Share API (with files)
  shareBtn.addEventListener('click', async () => {
    if(!capturedImage) return alert('No photo to share.');
    // If Web Share with files is supported
    if (navigator.canShare && navigator.canShare({ files: [] }) && navigator.share) {
      try {
        // Convert dataURL -> blob -> File
        const blob = await (await fetch(capturedImage)).blob();
        const file = new File([blob], 'mysidhi.png', { type: blob.type });
        await navigator.share({
          files: [file],
          title: 'Photo from MySidhi',
          text: 'Photo captured with Camera'
        });
      } catch (err) {
        console.error('Share failed', err);
        alert('Share failed: ' + (err && err.message || err));
      }
    } else if (navigator.share) {
      // Legacy: share URL or text (can't share file). We can try to open the image in a new tab and ask user to share manually.
      try {
        await navigator.share({ title: 'Photo', text: 'Photo captured ‚Äî save or download it', url: capturedImage });
      } catch (err) {
        console.error('Share fallback failed', err);
        alert('Share unavailable on this browser. Please download the photo instead.');
      }
    } else {
      // No Web Share support -> fallback to download
      alert('Web Share not supported on this device/browser. The photo will be downloaded instead.');
      downloadBtn.click();
    }
  });

  // save to gallery (Android: attempt to open blob URL so user can long-press, or suggest download)
  saveBtn.addEventListener('click', async () => {
    if(!capturedImage) return;
    // Try saving the blob and opening it in a new tab (user can long-press to save)
    try {
      const blob = await (await fetch(capturedImage)).blob();
      const blobUrl = URL.createObjectURL(blob);
      const w = window.open(blobUrl, '_blank');
      if(!w) {
        // popup blocked -> download instead
        downloadBtn.click();
      }
      // revoke after a delay
      setTimeout(()=> URL.revokeObjectURL(blobUrl), 30000);
    } catch (err) {
      console.error(err);
      downloadBtn.click();
    }
  });

  // stop camera
  stopBtn.addEventListener('click', () => {
    if(mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
      video.srcObject = null;
      clearInterval(scanInterval);
      setStatus(false, 'Camera Off');
      setTimeout(()=> alert('Camera turned off.'), 10);
    } else setStatus(false, 'Camera Off');
  });

  // switch cameras
  switchFrontBtn.addEventListener('click', () => { currentFacingMode = 'user'; getMediaStream(); });
  switchBackBtn.addEventListener('click', () => { currentFacingMode = 'environment'; getMediaStream(); });

  // modes
  qrModeBtn.addEventListener('click', () => setMode('qr'));
  captureModeBtn.addEventListener('click', () => setMode('capture'));

  // QR scan
  function startQRScan(){
    clearInterval(scanInterval);
    if(!video.videoWidth) {
      scanInterval = setTimeout(startQRScan, 300);
      return;
    }
    const ctx = canvas.getContext('2d');
    scanInterval = setInterval(() => {
      if(!video.videoWidth) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      if (currentFacingMode === 'user') {
        ctx.save();
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        ctx.restore();
      } else ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const qr = jsQR(imageData.data, imageData.width, imageData.height);
        if(qr) {
          qrResult.textContent = 'QR Code: ' + qr.data;
          clearInterval(scanInterval);
          if(qr.data && (qr.data.startsWith('http://') || qr.data.startsWith('https://'))) {
            setTimeout(()=> window.open(qr.data, '_blank'), 150);
          }
        }
      } catch (err) {
        console.error('QR error', err);
      }
    }, 450);
  }

  // init
  (async function init(){
    setMode('capture');
    await getMediaStream().catch(()=>{});
  })();

  // cleanup
  window.addEventListener('beforeunload', ()=> { if(mediaStream) mediaStream.getTracks().forEach(t=>t.stop()); });
  // keyboard: space = snapshot
  window.addEventListener('keydown', (e) => { if(e.key === ' ') { e.preventDefault(); snapBtn.click(); }});
</script>
</body>
</html>
